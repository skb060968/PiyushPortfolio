/**
 * Auto-generate portfolio data from public/images/portfolio
 * Correct hero / thumbnail separation
 */

const fs = require("fs")
const path = require("path")

const ROOT = path.join(process.cwd(), "public", "images", "portfolio")
const OUTPUT = path.join(process.cwd(), "lib", "data", "portfolio.ts")

const isImage = (file) => /\.(jpg|jpeg|png|webp)$/i.test(file)

const normalize = (name) => name.toLowerCase()

const readJSON = (filePath) => {
  if (!fs.existsSync(filePath)) return {}
  try {
    return JSON.parse(fs.readFileSync(filePath, "utf-8"))
  } catch {
    return {}
  }
}

const publicPath = (abs) =>
  abs.replace(path.join(process.cwd(), "public"), "").replace(/\\/g, "/")

const portfolio = {}

for (const category of fs.readdirSync(ROOT)) {
  const categoryPath = path.join(ROOT, category)
  if (!fs.statSync(categoryPath).isDirectory()) continue

  const categoryMeta = readJSON(path.join(categoryPath, "meta.json"))

  portfolio[category] = {
    title: categoryMeta.title || category,
    description: categoryMeta.description || "",
    thumbnail: publicPath(path.join(categoryPath, "thumbnail.jpg")),
    projects: {},
  }

  for (const project of fs.readdirSync(categoryPath)) {
    const projectPath = path.join(categoryPath, project)
    if (!fs.statSync(projectPath).isDirectory()) continue
    if (project === "meta.json") continue

    const projectMeta = readJSON(path.join(projectPath, "meta.json"))

    portfolio[category].projects[project] = {
      title: projectMeta.title || project,
      description: projectMeta.description || "",
      thumbnail: publicPath(path.join(projectPath, "thumbnail.jpg")),
      fields: {},
    }

    for (const field of fs.readdirSync(projectPath)) {
      const fieldPath = path.join(projectPath, field)
      if (!fs.statSync(fieldPath).isDirectory()) continue
      if (field === "meta.json") continue

      const fieldMeta = readJSON(path.join(fieldPath, "meta.json"))

      let hero = ""
      let thumbnail = ""
      const images = []

      for (const file of fs.readdirSync(fieldPath)) {
        if (!isImage(file)) continue

        const fileLower = normalize(file)
        const rel = publicPath(path.join(fieldPath, file))

        if (fileLower === "hero.jpg") {
          hero = rel
        } else if (fileLower === "thumbnail.jpg") {
          thumbnail = rel
        } else {
          images.push(rel)
        }
      }

      if (!hero) {
        console.warn(`⚠️ Missing hero.jpg in ${fieldPath}`)
        hero = thumbnail
      }

      portfolio[category].projects[project].fields[field] = {
        title: fieldMeta.title || field,
        description: fieldMeta.description || "",
        thumbnail,
        hero,
        images,
      }
    }
  }
}

/* ---------- WRITE FILE ---------- */

const output = `
// ⚠️ AUTO-GENERATED FILE — DO NOT EDIT
// Generated by generate-portfolio-data.js

export type FieldData = {
  title: string
  description: string
  thumbnail: string
  hero: string
  images: string[]
}

export type SubProject = {
  title: string
  description: string
  thumbnail: string
  fields: Record<string, FieldData>
}

export type CategoryData = {
  title: string
  description: string
  thumbnail: string
  projects: Record<string, SubProject>
}

export const portfolioData: Record<string, CategoryData> = ${JSON.stringify(
  portfolio,
  null,
  2
)}
`

fs.writeFileSync(OUTPUT, output.trim() + "\n", "utf-8")

console.log("✅ portfolio.ts generated successfully")
